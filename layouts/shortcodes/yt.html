{{- $includeAssets := true -}}
{{- $isFeed := false -}}
{{- with .Page -}}
  {{- with .OutputFormat -}}
    {{- $formatName := lower .Name -}}
    {{- if in (slice "rss" "atom" "json" "jsonfeed") $formatName -}}
      {{- $isFeed = true -}}
    {{- else if .MediaType -}}
      {{- $mediaType := lower .MediaType.Type -}}
      {{- if or (strings.Contains $mediaType "rss") (strings.Contains $mediaType "atom") (strings.Contains $mediaType "json") (strings.HasSuffix $mediaType "xml") -}}
        {{- $isFeed = true -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
  {{- if .Scratch.Get "yt-nocookie-assets" -}}
    {{- $includeAssets = false -}}
  {{- else -}}
    {{- .Scratch.Set "yt-nocookie-assets" true -}}
  {{- end -}}
  {{- $permalink := "" -}}
  {{- with .RelPermalink -}}
    {{- $permalink = . -}}
  {{- end -}}
  {{- if eq $permalink "" -}}
    {{- with .Permalink -}}
      {{- $permalink = . -}}
    {{- end -}}
  {{- end -}}
  {{- $permalinkLower := lower $permalink -}}
  {{- if or (strings.HasSuffix $permalinkLower ".xml") (strings.HasSuffix $permalinkLower ".json") -}}
    {{- $isFeed = true -}}
  {{- end -}}
{{- end -}}
{{- if $isFeed -}}
  {{- $includeAssets = false -}}
{{- end -}}

{{- if $includeAssets }}
<style>
.video-wrapper {
  position: relative;
  display: block;
  width: 100%;
  padding: 0;
  padding-bottom: 56.25%;
  margin: 0;
  height: 0;
  max-width: 100%;
  overflow: hidden;
  background-color: #000;
  cursor: pointer;
  outline: none;
  border: none;
  color: inherit;
  font: inherit;
  text-align: inherit;
  appearance: none;
  -webkit-appearance: none;
}

.video-wrapper[data-is-loaded="true"] {
  cursor: auto;
}

.video-wrapper:focus-visible {
  outline: 3px solid #e53935;
  outline-offset: 4px;
}

.video-wrapper.rounded-corners {
  border-radius: 10px;
}

.video-thumbnail {
  position: absolute;
  top: 0;
  right: 0;
  bottom: 0;
  left: 0;
  margin: auto;
  max-width: 100%;
  max-height: 100%;
  width: auto;
  height: auto;
  object-fit: contain;
  object-position: center;
  background-color: #000;
  z-index: 1;
}

.video-overlay {
  position: absolute;
  bottom: 0;
  left: 0;
  width: 100%;
  background: rgba(0, 0, 0, 0.85);
  color: white;
  text-align: center;
  font-size: 0.85em;
  padding: 0.5em 1em;
  z-index: 2;
  pointer-events: auto;
}

.video-wrapper.rounded-corners .video-overlay {
  border-radius: 0 0 10px 10px;
}

.video-play-button {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 68px;
  height: 48px;
  background-color: rgba(255, 0, 0, 0.8);
  border-radius: 12px;
  z-index: 3;
  pointer-events: none;
}

.video-play-button::before {
  content: '';
  position: absolute;
  left: 26px;
  top: 14px;
  width: 0;
  height: 0;
  border-left: 18px solid white;
  border-top: 12px solid transparent;
  border-bottom: 12px solid transparent;
}

.video-wrapper iframe {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  border: none;
  z-index: 4;
}

.video-noscript {
  display: block;
  max-width: 100%;
  background-color: #000;
  color: inherit;
  text-align: center;
  padding: 0;
  margin-top: 0.5em;
}

.video-noscript.rounded-corners {
  border-radius: 10px;
  overflow: hidden;
}

.video-noscript img {
  display: block;
  width: 100%;
  height: auto;
}

.video-noscript a {
  display: inline-block;
  padding: 0.75em 1em;
  color: inherit;
  text-decoration: underline;
}
</style>

<script>
(function(){
  function parseId(raw) {
    if (!raw) return { type: 'unknown' };
    raw = raw.trim();
    const idPattern = /^[a-zA-Z0-9_-]{11}$/;

    function parseStartValue(value) {
      if (!value) return 0;
      if (/^\d+$/.test(value)) return parseInt(value, 10);
      let total = 0;
      let matched = false;
      const regex = /(\d+)(h|m|s)/gi;
      let m;
      while ((m = regex.exec(value)) !== null) {
        matched = true;
        const num = parseInt(m[1], 10);
        switch (m[2].toLowerCase()) {
          case 'h':
            total += num * 3600;
            break;
          case 'm':
            total += num * 60;
            break;
          case 's':
            total += num;
            break;
        }
      }
      return matched ? total : 0;
    }

    function extractStart(searchLike) {
      if (!searchLike) return 0;
      const params = new URLSearchParams(searchLike.startsWith('?') || searchLike.startsWith('#') ? searchLike.slice(1) : searchLike);
      return parseStartValue(params.get('start')) || parseStartValue(params.get('t')) || parseStartValue(params.get('time_continue'));
    }

    let startSeconds = 0;
    const originalRaw = raw;

    let normalized = originalRaw;
    const queryIndex = normalized.indexOf('?');
    if (queryIndex !== -1) {
      startSeconds = startSeconds || extractStart(normalized.slice(queryIndex + 1));
      normalized = normalized.slice(0, queryIndex);
    }
    const hashIndex = normalized.indexOf('#');
    if (hashIndex !== -1) {
      startSeconds = startSeconds || extractStart(normalized.slice(hashIndex + 1));
      normalized = normalized.slice(0, hashIndex);
    }

    // Playlist-like IDs
    if (/^(PL|OL|UU|LL|FL)/i.test(normalized)) return { type: 'playlist', id: normalized, start: startSeconds };
    // Plain 11-char video ID
    if (idPattern.test(normalized)) return { type: 'video', id: normalized, start: startSeconds };

    // Fallback: extract list=...
    const m = normalized.match(/list=([^&]+)/);
    if (m) return { type: 'playlist', id: m[1], start: startSeconds };

    return { type: 'unknown', start: startSeconds };
  }

  function enhanceEmbeds() {
    document.querySelectorAll('.video-wrapper').forEach(wrapper => {
      if (wrapper.dataset.listenersAdded === 'true') return;
      wrapper.dataset.listenersAdded = 'true';

      let raw = wrapper.dataset.videoId || '';
      if (raw.length > 2048) { console.warn('video id too long, treating as unknown'); raw=''; }

      let customThumb = wrapper.dataset.thumb || '';
      customThumb = customThumb.trim();
      if (customThumb) {
        const markdownMatch = customThumb.match(/^\[[^\]]*\]\(([^)]+)\)$/);
        if (markdownMatch) {
          customThumb = markdownMatch[1].trim();
        }
      }
      let safeThumb = '';
      if (customThumb) {
        try {
          safeThumb = new URL(customThumb, document.baseURI).href;
        } catch (e) {
          safeThumb = '';
        }
      }
      const providedTitle = wrapper.dataset.videoTitle || '';

      const kind = parseId(raw);
      const overlay = wrapper.querySelector('.video-overlay');
      const thumbnail = wrapper.querySelector('.video-thumbnail');

      // Thumbnails
      if (safeThumb) {
        thumbnail.onerror = null;
        thumbnail.src = safeThumb;
      } else if (kind.type === 'playlist') {
        const svg = `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1280 720'>`+
                    `<rect width='100%' height='100%' fill='#000'/>`+
                    `<rect x='220' y='260' width='840' height='60' fill='#fff'/>`+
                    `<rect x='220' y='340' width='660' height='60' fill='#fff'/>`+
                    `</svg>`;
        thumbnail.src = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg);
      } else if (kind.type === 'video') {
        thumbnail.src = `https://img.youtube.com/vi/${kind.id}/maxresdefault.jpg`;
        thumbnail.onerror = () => { thumbnail.onerror = null; thumbnail.src = `https://img.youtube.com/vi/${kind.id}/0.jpg`; };
      } // unknown keeps the neutral placeholder

      function loadEmbed() {
        if (wrapper.dataset.isLoaded === 'true') return;
        let src = '';
        if (kind.type === 'playlist') {
          src = `https://www.youtube-nocookie.com/embed/videoseries?list=${encodeURIComponent(kind.id)}&autoplay=1&mute=1`;
        } else if (kind.type === 'video') {
          src = `https://www.youtube-nocookie.com/embed/${encodeURIComponent(kind.id)}?autoplay=1&mute=1`;
          if (kind.start) {
            src += `&start=${Math.max(0, kind.start | 0)}`;
          }
        } else {
          console.warn('YouTube nocookie shortcode: unable to determine video or playlist ID.');
          return;
        }
        const iframe = document.createElement('iframe');
        iframe.setAttribute('allowfullscreen','');
        iframe.setAttribute('loading','lazy');
        iframe.setAttribute('title', providedTitle ? `YouTube video player: ${providedTitle}` : 'YouTube video player');
        iframe.src = src;
        // clear and insert
        wrapper.dataset.isLoaded = 'true';
        const replacement = document.createElement('div');
        replacement.className = wrapper.className;
        replacement.dataset.listenersAdded = 'true';
        replacement.dataset.isLoaded = 'true';
        replacement.appendChild(iframe);
        wrapper.replaceWith(replacement);
      }

      // click anywhere inside wrapper
      wrapper.addEventListener('click', loadEmbed);
      if (overlay) overlay.addEventListener('click', loadEmbed);
      if (thumbnail) thumbnail.addEventListener('click', loadEmbed);
    });
  }

  enhanceEmbeds();
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', enhanceEmbeds);
  }
})();
</script>
{{- end }}

{{- $rawVideo := .Get 0 -}}
{{- $thumbURL := "" -}}
{{- with .Get 1 -}}
  {{- $thumb := . | plainify -}}
  {{- $thumb = replaceRE "(?s)^\\[[^\\]]*\\]\\(([^)]+)\\)$" "$1" $thumb -}}
  {{- $thumb = replaceRE "(?s).*\\(([^)]+)\\)$" "$1" $thumb -}}
  {{- $thumbURL = $thumb | absURL | safeURL -}}
{{- end -}}
{{- $blankPlaceholder := printf "%s" (replace (replace (replace (replace "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1280 720'><rect width='100%%' height='100%%' fill='#000'/></svg>" "#" "%23") "<" "%3C") ">" "%3E") "\n" "%0A") -}}
{{- $playlistPlaceholder := printf "%s" (replace (replace (replace (replace "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1280 720'><rect width='100%%' height='100%%' fill='#000'/><rect x='220' y='260' width='840' height='60' fill='#fff'/><rect x='220' y='340' width='660' height='60' fill='#fff'/></svg>" "#" "%23") "<" "%3C") ">" "%3E") "\n" "%0A") -}}

{{- $playlistID := "" -}}
{{- $videoID := "" -}}
{{- $cleanVideo := trim $rawVideo " \t\r\n" -}}
{{- if $cleanVideo -}}
  {{- $lowerVideo := lower $cleanVideo -}}
  {{- $upperVideo := upper $cleanVideo -}}
  {{- if or (hasPrefix $upperVideo "PL") (hasPrefix $upperVideo "OL") (hasPrefix $upperVideo "UU") (hasPrefix $upperVideo "LL") (hasPrefix $upperVideo "FL") -}}
    {{- $playlistID = $cleanVideo -}}
  {{- else if eq (len $cleanVideo) 11 -}}
    {{- $videoID = $cleanVideo -}}
  {{- end -}}
  {{- if and (eq $playlistID "") (eq $videoID "") -}}
    {{- if and (in $cleanVideo "list=") (not (hasPrefix $lowerVideo "http")) -}}
      {{- $listParts := split $cleanVideo "list=" -}}
      {{- if ge (len $listParts) 2 -}}
        {{- $afterList := index $listParts 1 -}}
        {{- $listCandidate := index (split $afterList "&") 0 -}}
        {{- $playlistID = index (split $listCandidate "#") 0 -}}
      {{- end -}}
    {{- end -}}
    {{- if and (eq $playlistID "") (in $cleanVideo "v=") -}}
      {{- $videoParts := split $cleanVideo "v=" -}}
      {{- if ge (len $videoParts) 2 -}}
        {{- $afterV := index $videoParts 1 -}}
        {{- $candidate := index (split $afterV "&") 0 -}}
        {{- $candidate = index (split $candidate "#") 0 -}}
        {{- if eq (len $candidate) 11 -}}
          {{- $videoID = $candidate -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- $videoLink := "" -}}
{{- if $playlistID -}}
  {{- $videoLink = printf "https://www.youtube.com/playlist?list=%s" $playlistID -}}
{{- else if $videoID -}}
  {{- $videoLink = printf "https://www.youtube.com/watch?v=%s" $videoID -}}
{{- end -}}

{{- $fallbackThumb := $thumbURL -}}
{{- if eq $fallbackThumb "" -}}
  {{- if $playlistID -}}
    {{- $fallbackThumb = printf "data:image/svg+xml;charset=utf-8,%s" $playlistPlaceholder -}}
  {{- else if $videoID -}}
    {{- $fallbackThumb = printf "https://img.youtube.com/vi/%s/maxresdefault.jpg" $videoID -}}
  {{- else -}}
    {{- $fallbackThumb = printf "data:image/svg+xml;charset=utf-8,%s" $blankPlaceholder -}}
  {{- end -}}
{{- end -}}

{{- $videoTitle := "" -}}
{{- with .Get "title" -}}
  {{- $videoTitle = . -}}
{{- end -}}
{{- if and (eq $videoTitle "") (ge (len .Params) 3) -}}
  {{- $videoTitle = index .Params 2 -}}
{{- end -}}
{{- $ariaLabel := "Play YouTube video" -}}
{{- if ne $videoTitle "" -}}
  {{- $ariaLabel = printf "Play video: %s" $videoTitle -}}
{{- end -}}

{{- $iframeSrc := "" -}}
{{- if $videoID -}}
  {{- $iframeSrc = printf "https://www.youtube-nocookie.com/embed/%s?rel=0" $videoID -}}
{{- else if $playlistID -}}
  {{- $iframeSrc = printf "https://www.youtube-nocookie.com/embed/videoseries?list=%s" $playlistID -}}
{{- end -}}
{{- $iframeTitle := cond (ne $videoTitle "") $videoTitle (cond (ne $playlistID "") "YouTube playlist" "YouTube video") -}}

{{- if $isFeed -}}
  {{- if $iframeSrc -}}
    <iframe
      src="{{ $iframeSrc | safeURL }}"
      width="560"
      height="315"
      title="{{ $iframeTitle }}"
      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
      allowfullscreen
      loading="lazy"></iframe>
  {{- end -}}
  {{- if $videoLink -}}
    <p>
      <a href="{{ $videoLink | safeURL }}">
        {{- if ne $videoTitle "" -}}
          Open video on YouTube: {{ $videoTitle }}
        {{- else if $playlistID -}}
          Open playlist on YouTube
        {{- else -}}
          Open video on YouTube
        {{- end -}}
      </a>
    </p>
  {{- end -}}
{{- else -}}
  <button type="button" class="video-wrapper{{ with .Site.Params.youtube_video_class }} {{ . }}{{ end }}{{ if eq .Site.Params.rounded_thumbnails true }} rounded-corners{{ end }}"
    aria-label="{{ $ariaLabel }}"
    data-video-id="{{ $rawVideo }}"
    data-thumb="{{ with $thumbURL }}{{ . }}{{ end }}"
    {{ with $videoTitle }}data-video-title="{{ . }}"{{ end }}>
    <img
      class="video-thumbnail"
      src="data:image/svg+xml;charset=utf-8,{{ $blankPlaceholder }}"
      alt="{{ if ne $videoTitle "" }}Thumbnail for video: {{ $videoTitle }}{{ else }}YouTube Thumbnail{{ end }}"
      loading="lazy"
      decoding="async">

    {{ if and (eq .Site.Params.show_privacy_notice true) (or .Site.Params.youtube_privacy_notice_text "") }}
      <div class="video-overlay">
        {{ with .Site.Params.youtube_privacy_notice_text }}
          {{ . }}
        {{ else }}
          Click to load video from YouTube. Personal data may be transferred.
        {{ end }}
      </div>
    {{ end }}

    <div class="video-play-button"></div>
  </button>

  <noscript>
    <div class="video-noscript{{ if eq .Site.Params.rounded_thumbnails true }} rounded-corners{{ end }}">
      {{- if $fallbackThumb -}}
        <img src="{{ $fallbackThumb | safeURL }}" alt="{{ if ne $videoTitle "" }}Thumbnail for video: {{ $videoTitle }}{{ else }}YouTube Thumbnail{{ end }}">
      {{- end -}}
      {{- if $videoLink -}}
        <p>
          <a href="{{ $videoLink | safeURL }}" target="_blank" rel="noopener noreferrer">
            {{- if ne $videoTitle "" -}}
              Open video on YouTube: {{ $videoTitle }}
            {{- else -}}
              Open video on YouTube
            {{- end -}}
          </a>
        </p>
      {{- end -}}
    </div>
  </noscript>
{{- end -}}
