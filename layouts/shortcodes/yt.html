{{- $includeAssets := true -}}
{{- with .Page -}}
  {{- if .Scratch.Get "yt-nocookie-assets" -}}
    {{- $includeAssets = false -}}
  {{- else -}}
    {{- .Scratch.Set "yt-nocookie-assets" true -}}
  {{- end -}}
{{- end -}}

{{- if $includeAssets }}
<style>
.video-wrapper {
  position: relative;
  display: block;
  width: 100%;
  padding: 0;
  padding-bottom: 56.25%;
  margin: 0;
  height: 0;
  max-width: 100%;
  overflow: hidden;
  background-color: #000;
  cursor: pointer;
  outline: none;
  border: none;
  color: inherit;
  font: inherit;
  text-align: inherit;
  appearance: none;
  -webkit-appearance: none;
}

.video-wrapper[data-is-loaded="true"] {
  cursor: auto;
}

.video-wrapper:focus-visible {
  outline: 3px solid #e53935;
  outline-offset: 4px;
}

.video-wrapper.rounded-corners {
  border-radius: 10px;
}

.video-thumbnail {
  position: absolute;
  top: 0;
  right: 0;
  bottom: 0;
  left: 0;
  margin: auto;
  max-width: 100%;
  max-height: 100%;
  width: auto;
  height: auto;
  object-fit: contain;
  object-position: center;
  background-color: #000;
  z-index: 1;
}

.video-overlay {
  position: absolute;
  bottom: 0;
  left: 0;
  width: 100%;
  background: rgba(0, 0, 0, 0.85);
  color: white;
  text-align: center;
  font-size: 0.85em;
  padding: 0.5em 1em;
  z-index: 2;
  pointer-events: auto;
}

.video-wrapper.rounded-corners .video-overlay {
  border-radius: 0 0 10px 10px;
}

.video-play-button {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 68px;
  height: 48px;
  background-color: rgba(255, 0, 0, 0.8);
  border-radius: 12px;
  z-index: 3;
  pointer-events: none;
}

.video-play-button::before {
  content: '';
  position: absolute;
  left: 26px;
  top: 14px;
  width: 0;
  height: 0;
  border-left: 18px solid white;
  border-top: 12px solid transparent;
  border-bottom: 12px solid transparent;
}

.video-wrapper iframe {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  border: none;
  z-index: 4;
}

.video-noscript {
  display: block;
  max-width: 100%;
  background-color: #000;
  color: inherit;
  text-align: center;
  padding: 0;
  margin-top: 0.5em;
}

.video-noscript.rounded-corners {
  border-radius: 10px;
  overflow: hidden;
}

.video-noscript img {
  display: block;
  width: 100%;
  height: auto;
}

.video-noscript a {
  display: inline-block;
  padding: 0.75em 1em;
  color: inherit;
  text-decoration: underline;
}
</style>

<script>
(function(){
  function parseId(raw) {
    if (!raw) return { type: 'unknown' };
    raw = raw.trim();
    const idPattern = /^[a-zA-Z0-9_-]{11}$/;

    function parseStartValue(value) {
      if (!value) return 0;
      if (/^\d+$/.test(value)) return parseInt(value, 10);
      let total = 0;
      let matched = false;
      const regex = /(\d+)(h|m|s)/gi;
      let m;
      while ((m = regex.exec(value)) !== null) {
        matched = true;
        const num = parseInt(m[1], 10);
        switch (m[2].toLowerCase()) {
          case 'h':
            total += num * 3600;
            break;
          case 'm':
            total += num * 60;
            break;
          case 's':
            total += num;
            break;
        }
      }
      return matched ? total : 0;
    }

    function extractStart(searchLike) {
      if (!searchLike) return 0;
      const params = new URLSearchParams(searchLike.startsWith('?') || searchLike.startsWith('#') ? searchLike.slice(1) : searchLike);
      return parseStartValue(params.get('start')) || parseStartValue(params.get('t')) || parseStartValue(params.get('time_continue'));
    }

    let startSeconds = 0;
    const originalRaw = raw;

    // Full URL handling
    try {
      if (raw.startsWith('http')) {
        const u = new URL(raw);
        const host = u.hostname.replace(/^www\./, '');
        const list = u.searchParams.get('list');
        const v = u.searchParams.get('v');
        startSeconds = extractStart(u.search) || extractStart(u.hash);
        if (list) return { type: 'playlist', id: list, start: startSeconds };
        if (v && idPattern.test(v)) return { type: 'video', id: v, start: startSeconds };

        const segments = u.pathname.split('/').filter(Boolean);
        const first = segments[0] || '';
        const second = segments[1] || '';
        if (host === 'youtu.be' && idPattern.test(first)) {
          return { type: 'video', id: first, start: startSeconds || extractStart(u.search) };
        }
        if (first === 'embed' && idPattern.test(second)) {
          return { type: 'video', id: second, start: startSeconds };
        }
        if (first === 'shorts' && idPattern.test(second)) {
          return { type: 'video', id: second, start: startSeconds };
        }
      }
    } catch(e) { /* ignore */ }

    let normalized = originalRaw;
    const queryIndex = normalized.indexOf('?');
    if (queryIndex !== -1) {
      startSeconds = startSeconds || extractStart(normalized.slice(queryIndex + 1));
      normalized = normalized.slice(0, queryIndex);
    }
    const hashIndex = normalized.indexOf('#');
    if (hashIndex !== -1) {
      startSeconds = startSeconds || extractStart(normalized.slice(hashIndex + 1));
      normalized = normalized.slice(0, hashIndex);
    }

    // Playlist-like IDs
    if (/^(PL|OL|UU|LL|FL)/i.test(normalized)) return { type: 'playlist', id: normalized, start: startSeconds };
    // Plain 11-char video ID
    if (idPattern.test(normalized)) return { type: 'video', id: normalized, start: startSeconds };

    // Fallback: extract list=...
    const m = normalized.match(/list=([^&]+)/);
    if (m) return { type: 'playlist', id: m[1], start: startSeconds };

    return { type: 'unknown', start: startSeconds };
  }

  function enhanceEmbeds() {
    document.querySelectorAll('.video-wrapper').forEach(wrapper => {
      if (wrapper.dataset.listenersAdded === 'true') return;
      wrapper.dataset.listenersAdded = 'true';

      let raw = wrapper.dataset.videoId || '';
      if (raw.length > 2048) { console.warn('video id too long, treating as unknown'); raw=''; }

      let customThumb = wrapper.dataset.thumb || '';
      customThumb = customThumb.trim();
      if (customThumb) {
        const markdownMatch = customThumb.match(/^\[[^\]]*\]\(([^)]+)\)$/);
        if (markdownMatch) {
          customThumb = markdownMatch[1].trim();
        }
      }
      let safeThumb = '';
      if (customThumb) {
        try {
          safeThumb = new URL(customThumb, document.baseURI).href;
        } catch (e) {
          safeThumb = '';
        }
      }
      const providedTitle = wrapper.dataset.videoTitle || '';

      const kind = parseId(raw);
      const overlay = wrapper.querySelector('.video-overlay');
      const thumbnail = wrapper.querySelector('.video-thumbnail');

      // Thumbnails
      if (safeThumb) {
        thumbnail.onerror = null;
        thumbnail.src = safeThumb;
      } else if (kind.type === 'playlist') {
        const svg = `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1280 720'>`+
                    `<rect width='100%' height='100%' fill='#000'/>`+
                    `<rect x='220' y='260' width='840' height='60' fill='#fff'/>`+
                    `<rect x='220' y='340' width='660' height='60' fill='#fff'/>`+
                    `</svg>`;
        thumbnail.src = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg);
      } else if (kind.type === 'video') {
        thumbnail.src = `https://img.youtube.com/vi/${kind.id}/maxresdefault.jpg`;
        thumbnail.onerror = () => { thumbnail.onerror = null; thumbnail.src = `https://img.youtube.com/vi/${kind.id}/0.jpg`; };
      } // unknown keeps the neutral placeholder

      function loadEmbed() {
        if (wrapper.dataset.isLoaded === 'true') return;
        let src = '';
        if (kind.type === 'playlist') {
          src = `https://www.youtube-nocookie.com/embed/videoseries?list=${encodeURIComponent(kind.id)}&autoplay=1&mute=1`;
        } else if (kind.type === 'video') {
          src = `https://www.youtube-nocookie.com/embed/${encodeURIComponent(kind.id)}?autoplay=1&mute=1`;
          if (kind.start) {
            src += `&start=${Math.max(0, kind.start | 0)}`;
          }
        } else {
          if (/^https?:\/\//i.test(raw)) {
            const joiner = raw.includes('?') ? '&' : '?';
            src = `${raw}${joiner}autoplay=1&mute=1`;
          } else {
            src = `https://www.youtube-nocookie.com/embed/${encodeURIComponent(raw)}?autoplay=1&mute=1`;
          }
        }
        const iframe = document.createElement('iframe');
        iframe.setAttribute('allowfullscreen','');
        iframe.setAttribute('loading','lazy');
        iframe.setAttribute('title', providedTitle ? `YouTube video player: ${providedTitle}` : 'YouTube video player');
        iframe.src = src;
        // clear and insert
        wrapper.dataset.isLoaded = 'true';
        const replacement = document.createElement('div');
        replacement.className = wrapper.className;
        replacement.dataset.listenersAdded = 'true';
        replacement.dataset.isLoaded = 'true';
        replacement.appendChild(iframe);
        wrapper.replaceWith(replacement);
      }

      // click anywhere inside wrapper
      wrapper.addEventListener('click', loadEmbed);
      if (overlay) overlay.addEventListener('click', loadEmbed);
      if (thumbnail) thumbnail.addEventListener('click', loadEmbed);
    });
  }

  enhanceEmbeds();
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', enhanceEmbeds);
  }
})();
</script>
{{- end }}

{{- $rawVideo := .Get 0 -}}
{{- $thumbURL := "" -}}
{{- with .Get 1 -}}
  {{- $thumb := . | plainify -}}
  {{- $thumb = replaceRE "(?s)^\\[[^\\]]*\\]\\(([^)]+)\\)$" "$1" $thumb -}}
  {{- $thumb = replaceRE "(?s).*\\(([^)]+)\\)$" "$1" $thumb -}}
  {{- $thumbURL = $thumb | absURL | safeURL -}}
{{- end -}}
{{- $blankPlaceholder := printf "%s" (replace (replace (replace (replace "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1280 720'><rect width='100%%' height='100%%' fill='#000'/></svg>" "#" "%23") "<" "%3C") ">" "%3E") "\n" "%0A") -}}
{{- $playlistPlaceholder := printf "%s" (replace (replace (replace (replace "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1280 720'><rect width='100%%' height='100%%' fill='#000'/><rect x='220' y='260' width='840' height='60' fill='#fff'/><rect x='220' y='340' width='660' height='60' fill='#fff'/></svg>" "#" "%23") "<" "%3C") ">" "%3E") "\n" "%0A") -}}

{{- $playlistID := "" -}}
{{- $videoID := "" -}}
{{- $cleanVideo := trim $rawVideo " \t\r\n" -}}
{{- if $cleanVideo -}}
  {{- $lowerVideo := lower $cleanVideo -}}
  {{- $upperVideo := upper $cleanVideo -}}
  {{- if hasPrefix $lowerVideo "http" -}}
    {{- with urls.Parse $cleanVideo -}}
      {{- $host := replace (lower .Host) "www." "" -}}
      {{- $queryVals := .Query -}}
      {{- $listParam := $queryVals.Get "list" -}}
      {{- $videoParam := $queryVals.Get "v" -}}
      {{- if $listParam -}}
        {{- $playlistID = $listParam -}}
      {{- end -}}
      {{- if and (eq $playlistID "") $videoParam (eq (len $videoParam) 11) -}}
        {{- $videoID = $videoParam -}}
      {{- end -}}
      {{- if and (eq $playlistID "") (eq $videoID "") -}}
        {{- $path := strings.TrimPrefix .Path "/" -}}
        {{- $segments := split $path "/" -}}
        {{- $first := index $segments 0 | default "" -}}
        {{- $second := index $segments 1 | default "" -}}
        {{- if and (eq $host "youtu.be") (eq (len $first) 11) -}}
          {{- $videoID = $first -}}
        {{- else if and (eq $first "embed") (eq (len $second) 11) -}}
          {{- $videoID = $second -}}
        {{- else if and (eq $first "shorts") (eq (len $second) 11) -}}
          {{- $videoID = $second -}}
        {{- else if and (eq $first "playlist") $listParam -}}
          {{- $playlistID = $listParam -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}
  {{- else -}}
    {{- if or (hasPrefix $upperVideo "PL") (hasPrefix $upperVideo "OL") (hasPrefix $upperVideo "UU") (hasPrefix $upperVideo "LL") (hasPrefix $upperVideo "FL") -}}
      {{- $playlistID = $cleanVideo -}}
    {{- else if eq (len $cleanVideo) 11 -}}
      {{- $videoID = $cleanVideo -}}
    {{- end -}}
  {{- end -}}
  {{- if and (eq $playlistID "") (eq $videoID "") -}}
    {{- if and (in $cleanVideo "list=") (not (hasPrefix $lowerVideo "http")) -}}
      {{- $listIndex := strings.Index $cleanVideo "list=" -}}
      {{- if ge $listIndex 0 -}}
        {{- $afterList := substr $cleanVideo (add $listIndex (len "list=")) -}}
        {{- $listCandidate := index (split $afterList "&") 0 -}}
        {{- $playlistID = index (split $listCandidate "#") 0 -}}
      {{- end -}}
    {{- end -}}
    {{- if and (eq $playlistID "") (in $cleanVideo "v=") -}}
      {{- $vIndex := strings.Index $cleanVideo "v=" -}}
      {{- if ge $vIndex 0 -}}
        {{- $afterV := substr $cleanVideo (add $vIndex (len "v=")) -}}
        {{- $candidate := index (split $afterV "&") 0 -}}
        {{- $candidate = index (split $candidate "#") 0 -}}
        {{- if eq (len $candidate) 11 -}}
          {{- $videoID = $candidate -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- $videoLink := $rawVideo -}}
{{- if $rawVideo -}}
  {{- if hasPrefix (lower $rawVideo) "http" -}}
    {{- $videoLink = $rawVideo | safeURL -}}
  {{- else if $playlistID -}}
    {{- $videoLink = printf "https://www.youtube.com/playlist?list=%s" $playlistID -}}
  {{- else if $videoID -}}
    {{- $videoLink = printf "https://www.youtube.com/watch?v=%s" $videoID -}}
  {{- else -}}
    {{- $videoLink = printf "https://www.youtube.com/watch?v=%s" $rawVideo -}}
  {{- end -}}
{{- end -}}

{{- $fallbackThumb := $thumbURL -}}
{{- if eq $fallbackThumb "" -}}
  {{- if $playlistID -}}
    {{- $fallbackThumb = printf "data:image/svg+xml;charset=utf-8,%s" $playlistPlaceholder -}}
  {{- else if $videoID -}}
    {{- $fallbackThumb = printf "https://img.youtube.com/vi/%s/maxresdefault.jpg" $videoID -}}
  {{- else -}}
    {{- $fallbackThumb = printf "data:image/svg+xml;charset=utf-8,%s" $blankPlaceholder -}}
  {{- end -}}
{{- end -}}

{{- $videoTitle := "" -}}
{{- with .Get "title" -}}
  {{- $videoTitle = . -}}
{{- end -}}
{{- if and (eq $videoTitle "") (ge (len .Params) 3) -}}
  {{- $videoTitle = index .Params 2 -}}
{{- end -}}
{{- $ariaLabel := "Play YouTube video" -}}
{{- if ne $videoTitle "" -}}
  {{- $ariaLabel = printf "Play video: %s" $videoTitle -}}
{{- end -}}

<button type="button" class="video-wrapper{{ with .Site.Params.youtube_video_class }} {{ . }}{{ end }}{{ if eq .Site.Params.rounded_thumbnails true }} rounded-corners{{ end }}"
  aria-label="{{ $ariaLabel }}"
  data-video-id="{{ $rawVideo }}"
  data-thumb="{{ with $thumbURL }}{{ . }}{{ end }}"
  {{ with $videoTitle }}data-video-title="{{ . }}"{{ end }}>
  <img
    class="video-thumbnail"
    src="data:image/svg+xml;charset=utf-8,{{ $blankPlaceholder }}"
    alt="{{ if ne $videoTitle "" }}Thumbnail for video: {{ $videoTitle }}{{ else }}YouTube Thumbnail{{ end }}"
    loading="lazy"
    decoding="async">

  {{ if and (eq .Site.Params.show_privacy_notice true) (or .Site.Params.youtube_privacy_notice_text "") }}
    <div class="video-overlay">
      {{ with .Site.Params.youtube_privacy_notice_text }}
        {{ . }}
      {{ else }}
        Click to load video from YouTube. Personal data may be transferred.
      {{ end }}
    </div>
  {{ end }}

  <div class="video-play-button"></div>
</button>

<noscript>
  <div class="video-noscript{{ if eq .Site.Params.rounded_thumbnails true }} rounded-corners{{ end }}">
    {{- if $fallbackThumb -}}
      <img src="{{ $fallbackThumb | safeURL }}" alt="{{ if ne $videoTitle "" }}Thumbnail for video: {{ $videoTitle }}{{ else }}YouTube Thumbnail{{ end }}">
    {{- end -}}
    {{- if $videoLink -}}
      <p>
        <a href="{{ $videoLink | safeURL }}" target="_blank" rel="noopener noreferrer">
          {{- if ne $videoTitle "" -}}
            Open video on YouTube: {{ $videoTitle }}
          {{- else -}}
            Open video on YouTube
          {{- end -}}
        </a>
      </p>
    {{- end -}}
  </div>
</noscript>
