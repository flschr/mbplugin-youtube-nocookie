{{- $includeAssets := true -}}
{{- $isFeed := false -}}

{{- with .Page -}}
  {{- $page := . -}}
  {{- if .Scratch.Get "yt-nocookie-assets" -}}
    {{- $includeAssets = false -}}
  {{- else -}}
    {{- .Scratch.Set "yt-nocookie-assets" true -}}
  {{- end -}}
  {{- $permalink := "" -}}
  {{- $relPermalink := "" -}}
  {{- with .RelPermalink -}}
    {{- $permalink = . -}}
    {{- $relPermalink = . -}}
  {{- end -}}
  {{- if eq $permalink "" -}}
    {{- with .Permalink -}}
      {{- $permalink = . -}}
    {{- end -}}
  {{- end -}}
  {{- /* Compare current permalink with known feed outputs */ -}}
  {{- $feedFormats := slice "rss" "atom" "json" -}}
  {{- range $feedFormats -}}
    {{- $formatName := upper . -}}
    {{- with $page.OutputFormats.Get $formatName -}}
      {{- if or (and (ne $permalink "") (eq $permalink .Permalink)) (and (ne $relPermalink "") (eq $relPermalink .RelPermalink)) -}}
        {{- $isFeed = true -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
  {{- if not $isFeed -}}
    {{- $permalinkLower := lower $permalink -}}
    {{- if or (strings.HasSuffix $permalinkLower ".xml") (strings.HasSuffix $permalinkLower ".json") -}}
      {{- $isFeed = true -}}
    {{- end -}}
  {{- end -}}
{{- end -}}
{{- if $isFeed -}}
  {{- $includeAssets = false -}}
{{- end -}}

{{- if $includeAssets }}
<style>
:root {
  /* Aspect Ratios */
  --yt-aspect-ratio-16-9: 56.25%;

  /* Colors */
  --yt-bg-black: #000;
  --yt-play-button-bg: rgba(255, 0, 0, 0.8);
  --yt-play-button-bg-hover: rgba(255, 0, 0, 1);
  --yt-play-button-icon: #fff;
  --yt-overlay-bg: rgba(0, 0, 0, 0.85);
  --yt-overlay-text: #fff;
  --yt-focus-outline: #e53935;

  /* Dimensions */
  --yt-play-button-width: 68px;
  --yt-play-button-height: 48px;
  --yt-play-button-border-radius: 12px;

  /* Spacing */
  --yt-focus-outline-width: 3px;
  --yt-focus-outline-offset: 4px;

  /* Transitions */
  --yt-transition-duration: 0.2s;
  --yt-transition-timing: ease-in-out;
}

.video-wrapper {
  position: relative;
  display: block;
  width: 100%;
  padding: 0;
  padding-bottom: var(--yt-aspect-ratio-16-9);
  margin: 0;
  height: 0;
  max-width: 100%;
  overflow: hidden;
  background-color: var(--yt-bg-black);
  cursor: pointer;
  outline: none;
  border: none;
  color: inherit;
  font: inherit;
  text-align: inherit;
  appearance: none;
  -webkit-appearance: none;
}

.video-wrapper[data-is-loaded="true"] {
  cursor: auto;
}

.video-wrapper:focus-visible {
  outline: var(--yt-focus-outline-width) solid var(--yt-focus-outline);
  outline-offset: var(--yt-focus-outline-offset);
}

.video-thumbnail {
  position: absolute;
  top: 0;
  right: 0;
  bottom: 0;
  left: 0;
  margin: auto;
  max-width: 100%;
  max-height: 100%;
  width: auto;
  height: auto;
  object-fit: contain;
  object-position: center;
  background-color: var(--yt-bg-black);
  z-index: 1;
  transition: opacity var(--yt-transition-duration) var(--yt-transition-timing);
}

.video-wrapper:hover .video-thumbnail {
  opacity: 0.9;
}

.video-overlay {
  position: absolute;
  bottom: 0;
  left: 0;
  width: 100%;
  background: var(--yt-overlay-bg);
  color: var(--yt-overlay-text);
  text-align: center;
  font-size: 0.85em;
  padding: 0.5em 1em;
  z-index: 2;
  pointer-events: auto;
}

.video-play-button {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: var(--yt-play-button-width);
  height: var(--yt-play-button-height);
  background-color: var(--yt-play-button-bg);
  border-radius: var(--yt-play-button-border-radius);
  z-index: 3;
  pointer-events: none;
  transition: all var(--yt-transition-duration) var(--yt-transition-timing);
}

.video-wrapper:hover .video-play-button {
  background-color: var(--yt-play-button-bg-hover);
  transform: translate(-50%, -50%) scale(1.1);
}

.video-wrapper:active .video-play-button {
  transform: translate(-50%, -50%) scale(1.05);
}

.video-play-button::before {
  content: '';
  position: absolute;
  left: 26px;
  top: 14px;
  width: 0;
  height: 0;
  border-left: 18px solid var(--yt-play-button-icon);
  border-top: 12px solid transparent;
  border-bottom: 12px solid transparent;
}

.video-wrapper iframe {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  border: none;
  z-index: 4;
}

.video-noscript {
  display: block;
  max-width: 100%;
  background-color: var(--yt-bg-black);
  color: inherit;
  text-align: center;
  padding: 0;
  margin-top: 0.5em;
}

.video-noscript img {
  display: block;
  width: 100%;
  height: auto;
}

.video-noscript a {
  display: inline-block;
  padding: 0.75em 1em;
  color: inherit;
  text-decoration: underline;
}
</style>

<script>
(function(){
  'use strict';

  // Constants
  const CONSTANTS = {
    VIDEO_ID_LENGTH: 11,
    MAX_INPUT_LENGTH: 2048,
    VIDEO_ID_PATTERN: /^[a-zA-Z0-9_-]{11}$/,
    PLAYLIST_PREFIXES: /^(PL|OL|UU|LL|FL)/i,
    ALLOWED_URL_CHARS: /^[a-zA-Z0-9_\-?=&#:/.]+$/,
    TIME_FORMATS: {
      HOURS: 3600,
      MINUTES: 60,
      SECONDS: 1
    },
    YOUTUBE_NOCOOKIE_DOMAIN: 'https://www.youtube-nocookie.com',
    YOUTUBE_IMG_DOMAIN: 'https://img.youtube.com',
    EMBED_PARAMS: 'autoplay=1&mute=1'
  };

  /**
   * Validates input string for security
   * @param {string} input - Input string to validate
   * @param {number} maxLength - Maximum allowed length
   * @returns {string} Sanitized input or empty string if invalid
   */
  function validateInput(input, maxLength = CONSTANTS.MAX_INPUT_LENGTH) {
    if (!input || typeof input !== 'string') return '';

    const trimmed = input.trim();

    if (trimmed.length > maxLength) {
      console.warn(`Input exceeds maximum length of ${maxLength}`);
      return '';
    }

    // Basic sanitization - allow only safe characters
    if (!CONSTANTS.ALLOWED_URL_CHARS.test(trimmed)) {
      console.warn('Input contains invalid characters');
      return '';
    }

    return trimmed;
  }

  /**
   * Parses time value from various formats (123, 1h2m3s, etc.)
   * @param {string} value - Time value to parse
   * @returns {number} Time in seconds
   */
  function parseStartValue(value) {
    if (!value) return 0;

    // Simple numeric value
    if (/^\d+$/.test(value)) {
      const parsed = parseInt(value, 10);
      return isNaN(parsed) ? 0 : Math.max(0, parsed);
    }

    // Parse h/m/s format
    let total = 0;
    let matched = false;
    const regex = /(\d+)(h|m|s)/gi;
    let match;

    while ((match = regex.exec(value)) !== null) {
      matched = true;
      const num = parseInt(match[1], 10);
      if (isNaN(num)) continue;

      const unit = match[2].toLowerCase();
      if (unit === 'h') total += num * CONSTANTS.TIME_FORMATS.HOURS;
      else if (unit === 'm') total += num * CONSTANTS.TIME_FORMATS.MINUTES;
      else if (unit === 's') total += num * CONSTANTS.TIME_FORMATS.SECONDS;
    }

    return matched ? Math.max(0, total) : 0;
  }

  /**
   * Extracts start time from URL parameters
   * @param {string} queryString - Query or hash string
   * @returns {number} Start time in seconds
   */
  function extractStartTime(queryString) {
    if (!queryString) return 0;

    try {
      const cleanQuery = queryString.startsWith('?') || queryString.startsWith('#')
        ? queryString.slice(1)
        : queryString;

      const params = new URLSearchParams(cleanQuery);

      // Check common time parameters
      return parseStartValue(params.get('start')) ||
             parseStartValue(params.get('t')) ||
             parseStartValue(params.get('time_continue')) ||
             0;
    } catch (e) {
      console.warn('Failed to parse query parameters:', e);
      return 0;
    }
  }

  /**
   * Parses video/playlist ID from various input formats
   * @param {string} raw - Raw input string
   * @returns {Object} Parsed result with type, id, and start time
   */
  function parseId(raw) {
    const validated = validateInput(raw);
    if (!validated) {
      return { type: 'unknown', id: '', start: 0 };
    }

    let startSeconds = 0;
    let normalized = validated;

    // Extract and remove query parameters
    const queryIndex = normalized.indexOf('?');
    if (queryIndex !== -1) {
      startSeconds = extractStartTime(normalized.slice(queryIndex + 1));
      normalized = normalized.slice(0, queryIndex);
    }

    // Extract and remove hash parameters
    const hashIndex = normalized.indexOf('#');
    if (hashIndex !== -1) {
      startSeconds = startSeconds || extractStartTime(normalized.slice(hashIndex + 1));
      normalized = normalized.slice(0, hashIndex);
    }

    // Check for playlist prefixes
    if (CONSTANTS.PLAYLIST_PREFIXES.test(normalized)) {
      return { type: 'playlist', id: normalized, start: startSeconds };
    }

    // Check for plain 11-character video ID
    if (CONSTANTS.VIDEO_ID_PATTERN.test(normalized)) {
      return { type: 'video', id: normalized, start: startSeconds };
    }

    // Try to extract playlist ID from list= parameter
    const listMatch = normalized.match(/list=([^&]+)/);
    if (listMatch && listMatch[1]) {
      return { type: 'playlist', id: listMatch[1], start: startSeconds };
    }

    console.warn('Unable to parse video/playlist ID:', raw);
    return { type: 'unknown', id: '', start: startSeconds };
  }

  /**
   * Validates and sanitizes custom thumbnail URL
   * @param {string} thumbUrl - Custom thumbnail URL
   * @returns {string} Safe URL or empty string
   */
  function validateThumbnailUrl(thumbUrl) {
    if (!thumbUrl) return '';

    let cleaned = thumbUrl.trim();

    // Extract URL from markdown syntax
    const markdownMatch = cleaned.match(/^\[[^\]]*\]\(([^)]+)\)$/);
    if (markdownMatch) {
      cleaned = markdownMatch[1].trim();
    }

    // Validate URL format
    try {
      const url = new URL(cleaned, document.baseURI);

      // Only allow http/https protocols
      if (url.protocol !== 'http:' && url.protocol !== 'https:') {
        console.warn('Thumbnail URL must use http or https protocol');
        return '';
      }

      return url.href;
    } catch (e) {
      console.warn('Invalid thumbnail URL:', e);
      return '';
    }
  }

  /**
   * Generates SVG placeholder for playlists
   * @returns {string} Data URI for SVG
   */
  function getPlaylistPlaceholder() {
    const svg = `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1280 720'>` +
                `<rect width='100%' height='100%' fill='#000'/>` +
                `<rect x='220' y='260' width='840' height='60' fill='#fff'/>` +
                `<rect x='220' y='340' width='660' height='60' fill='#fff'/>` +
                `</svg>`;
    return 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg);
  }

  /**
   * Sets up thumbnail for video wrapper
   * @param {HTMLImageElement} thumbnail - Thumbnail element
   * @param {Object} kind - Parsed video/playlist info
   * @param {string} customThumb - Custom thumbnail URL
   */
  function setupThumbnail(thumbnail, kind, customThumb) {
    if (!thumbnail) return;

    if (customThumb) {
      // Use custom thumbnail
      thumbnail.onerror = null;
      thumbnail.src = customThumb;
    } else if (kind.type === 'playlist') {
      // Use playlist placeholder
      thumbnail.src = getPlaylistPlaceholder();
    } else if (kind.type === 'video' && kind.id) {
      // Use YouTube thumbnail with fallback
      thumbnail.src = `${CONSTANTS.YOUTUBE_IMG_DOMAIN}/vi/${kind.id}/maxresdefault.jpg`;
      thumbnail.onerror = () => {
        thumbnail.onerror = null;
        thumbnail.src = `${CONSTANTS.YOUTUBE_IMG_DOMAIN}/vi/${kind.id}/0.jpg`;
      };
    }
    // For unknown type, keep the default placeholder
  }

  /**
   * Creates embed URL for video or playlist
   * @param {Object} kind - Parsed video/playlist info
   * @returns {string} Embed URL or empty string if invalid
   */
  function createEmbedUrl(kind) {
    if (kind.type === 'playlist' && kind.id) {
      return `${CONSTANTS.YOUTUBE_NOCOOKIE_DOMAIN}/embed/videoseries?list=${encodeURIComponent(kind.id)}&${CONSTANTS.EMBED_PARAMS}`;
    } else if (kind.type === 'video' && kind.id) {
      let url = `${CONSTANTS.YOUTUBE_NOCOOKIE_DOMAIN}/embed/${encodeURIComponent(kind.id)}?${CONSTANTS.EMBED_PARAMS}`;
      if (kind.start > 0) {
        url += `&start=${Math.floor(kind.start)}`;
      }
      return url;
    }
    return '';
  }

  /**
   * Creates and loads iframe embed
   * @param {HTMLElement} wrapper - Video wrapper element
   * @param {Object} kind - Parsed video/playlist info
   * @param {string} title - Video title
   */
  function loadEmbed(wrapper, kind, title) {
    if (wrapper.dataset.isLoaded === 'true') return;

    const embedUrl = createEmbedUrl(kind);
    if (!embedUrl) {
      console.error('Unable to create embed URL - invalid video/playlist ID');
      // Show error message to user
      wrapper.innerHTML = '<div style="padding: 2em; text-align: center; color: #fff;">Unable to load video. Please check the video ID.</div>';
      return;
    }

    // Create iframe
    const iframe = document.createElement('iframe');
    iframe.setAttribute('allowfullscreen', '');
    iframe.setAttribute('loading', 'lazy');
    iframe.setAttribute('allow', 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture');
    iframe.setAttribute('title', title ? `YouTube video player: ${title}` : 'YouTube video player');
    iframe.src = embedUrl;

    // Replace wrapper with new container
    const replacement = document.createElement('div');
    replacement.className = wrapper.className;
    replacement.dataset.listenersAdded = 'true';
    replacement.dataset.isLoaded = 'true';
    replacement.appendChild(iframe);

    wrapper.replaceWith(replacement);
  }

  /**
   * Enhances all video wrapper elements with interactivity
   */
  function enhanceEmbeds() {
    const wrappers = document.querySelectorAll('.video-wrapper');

    wrappers.forEach(wrapper => {
      // Skip if already enhanced
      if (wrapper.dataset.listenersAdded === 'true') return;
      wrapper.dataset.listenersAdded = 'true';

      // Extract data attributes
      const rawVideoId = wrapper.dataset.videoId || '';
      const rawThumbUrl = wrapper.dataset.thumb || '';
      const videoTitle = wrapper.dataset.videoTitle || '';

      // Parse and validate
      const kind = parseId(rawVideoId);
      const safeThumb = validateThumbnailUrl(rawThumbUrl);

      // Setup thumbnail
      const thumbnail = wrapper.querySelector('.video-thumbnail');
      setupThumbnail(thumbnail, kind, safeThumb);

      // Setup click handlers
      const loadHandler = () => loadEmbed(wrapper, kind, videoTitle);

      wrapper.addEventListener('click', loadHandler);

      const overlay = wrapper.querySelector('.video-overlay');
      if (overlay) overlay.addEventListener('click', loadHandler);
      if (thumbnail) thumbnail.addEventListener('click', loadHandler);

      // Keyboard support (Enter and Space)
      wrapper.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          loadHandler();
        }
      });
    });
  }

  // Initialize
  enhanceEmbeds();
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', enhanceEmbeds);
  }
})();
</script>
{{- end }}

{{- /* Extract parameters */ -}}
{{- $rawVideo := .Get 0 -}}
{{- $thumbURL := "" -}}
{{- with .Get 1 -}}
  {{- $thumb := . | plainify -}}
  {{- /* Extract URL from markdown syntax */ -}}
  {{- $thumb = replaceRE "(?s)^\\[[^\\]]*\\]\\(([^)]+)\\)$" "$1" $thumb -}}
  {{- $thumb = replaceRE "(?s).*\\(([^)]+)\\)$" "$1" $thumb -}}
  {{- $thumbURL = $thumb | absURL | safeURL -}}
{{- end -}}

{{- /* Define SVG placeholders as constants */ -}}
{{- $blankSvg := "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1280 720'><rect width='100%%' height='100%%' fill='#000'/></svg>" -}}
{{- $playlistSvg := "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1280 720'><rect width='100%%' height='100%%' fill='#000'/><rect x='220' y='260' width='840' height='60' fill='#fff'/><rect x='220' y='340' width='660' height='60' fill='#fff'/></svg>" -}}

{{- /* URL-encode SVG for data URIs */ -}}
{{- $blankPlaceholder := $blankSvg | replaceRE "#" "%23" | replaceRE "<" "%3C" | replaceRE ">" "%3E" | replaceRE "\n" "%0A" -}}
{{- $playlistPlaceholder := $playlistSvg | replaceRE "#" "%23" | replaceRE "<" "%3C" | replaceRE ">" "%3E" | replaceRE "\n" "%0A" -}}

{{- /* Parse video/playlist ID from input */ -}}
{{- $playlistID := "" -}}
{{- $videoID := "" -}}
{{- $cleanVideo := trim $rawVideo " \t\r\n" -}}

{{- if $cleanVideo -}}
  {{- $upperVideo := upper $cleanVideo -}}

  {{- /* Check for playlist prefixes (PL, OL, UU, LL, FL) */ -}}
  {{- if or (hasPrefix $upperVideo "PL") (hasPrefix $upperVideo "OL") (hasPrefix $upperVideo "UU") (hasPrefix $upperVideo "LL") (hasPrefix $upperVideo "FL") -}}
    {{- $playlistID = $cleanVideo -}}
  {{- /* Check for 11-character video ID */ -}}
  {{- else if eq (len $cleanVideo) 11 -}}
    {{- $videoID = $cleanVideo -}}
  {{- /* Try to extract from query parameters */ -}}
  {{- else -}}
    {{- /* Extract playlist ID from list= parameter */ -}}
    {{- if in $cleanVideo "list=" -}}
      {{- $listParts := split $cleanVideo "list=" -}}
      {{- if ge (len $listParts) 2 -}}
        {{- $afterList := index $listParts 1 -}}
        {{- $listCandidate := index (split $afterList "&") 0 -}}
        {{- $playlistID = index (split $listCandidate "#") 0 -}}
      {{- end -}}
    {{- end -}}

    {{- /* Extract video ID from v= parameter if no playlist found */ -}}
    {{- if and (eq $playlistID "") (in $cleanVideo "v=") -}}
      {{- $videoParts := split $cleanVideo "v=" -}}
      {{- if ge (len $videoParts) 2 -}}
        {{- $afterV := index $videoParts 1 -}}
        {{- $candidate := index (split $afterV "&") 0 -}}
        {{- $candidate = index (split $candidate "#") 0 -}}
        {{- if eq (len $candidate) 11 -}}
          {{- $videoID = $candidate -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- /* Generate YouTube link for fallback */ -}}
{{- $videoLink := "" -}}
{{- if $videoID -}}
  {{- $videoLink = printf "https://www.youtube.com/watch?v=%s" $videoID -}}
{{- else if $playlistID -}}
  {{- $videoLink = printf "https://www.youtube.com/playlist?list=%s" $playlistID -}}
{{- end -}}

{{- /* Determine fallback thumbnail */ -}}
{{- $fallbackThumb := $thumbURL -}}
{{- if eq $fallbackThumb "" -}}
  {{- if $playlistID -}}
    {{- $fallbackThumb = printf "data:image/svg+xml;charset=utf-8,%s" $playlistPlaceholder -}}
  {{- else if $videoID -}}
    {{- $fallbackThumb = printf "https://img.youtube.com/vi/%s/maxresdefault.jpg" $videoID -}}
  {{- else -}}
    {{- $fallbackThumb = printf "data:image/svg+xml;charset=utf-8,%s" $blankPlaceholder -}}
  {{- end -}}
{{- end -}}

{{- /* Extract video title from parameters */ -}}
{{- $videoTitle := "" -}}
{{- with .Get "title" -}}
  {{- $videoTitle = . -}}
{{- end -}}
{{- if and (eq $videoTitle "") (ge (len .Params) 3) -}}
  {{- $videoTitle = index .Params 2 -}}
{{- end -}}

{{- /* Generate accessibility labels */ -}}
{{- $ariaLabel := "Play YouTube video" -}}
{{- if ne $videoTitle "" -}}
  {{- $ariaLabel = printf "Play video: %s" $videoTitle -}}
{{- end -}}

{{- /* Generate iframe src for feed embeds */ -}}
{{- $iframeSrc := "" -}}
{{- if $videoID -}}
  {{- $iframeSrc = printf "https://www.youtube-nocookie.com/embed/%s?rel=0" $videoID -}}
{{- else if $playlistID -}}
  {{- $iframeSrc = printf "https://www.youtube-nocookie.com/embed/videoseries?list=%s" $playlistID -}}
{{- end -}}
{{- $iframeTitle := cond (ne $videoTitle "") $videoTitle (cond (ne $playlistID "") "YouTube playlist" "YouTube video") -}}

{{- /* RSS/Atom/JSON Feed rendering */ -}}
{{- if $isFeed -}}
  {{- /* Render iframe directly in feeds */ -}}
  {{- if $iframeSrc -}}
    <iframe
      src="{{ $iframeSrc | safeURL }}"
      width="560"
      height="315"
      title="{{ $iframeTitle }}"
      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
      allowfullscreen
      loading="lazy"></iframe>
  {{- end -}}
  {{- /* Linked thumbnail fallback for feed readers */ -}}
  {{- if and $videoLink $fallbackThumb -}}
    <p>
      <a href="{{ $videoLink | safeURL }}">
        <img
          src="{{ $fallbackThumb | safeURL }}"
          alt="{{ if ne $videoTitle "" }}Thumbnail for video: {{ $videoTitle }}{{ else if $playlistID }}YouTube playlist thumbnail{{ else }}YouTube video thumbnail{{ end }}">
      </a>
    </p>
  {{- end -}}
  {{- /* Fallback link for feed readers that strip iframes */ -}}
  {{- if $videoLink -}}
    <p>
      <a href="{{ $videoLink | safeURL }}">
        {{- if ne $videoTitle "" -}}
          Open video on YouTube: {{ $videoTitle }}
        {{- else if $playlistID -}}
          Open playlist on YouTube
        {{- else -}}
          Open video on YouTube
        {{- end -}}
      </a>
    </p>
  {{- end -}}

{{- /* Regular page rendering with click-to-play */ -}}
{{- else -}}
  {{- /* Interactive button wrapper for click-to-play */ -}}
  <button type="button"
    class="video-wrapper{{ with .Site.Params.youtube_video_class }} {{ . }}{{ end }}"
    aria-label="{{ $ariaLabel }}"
    data-video-id="{{ $rawVideo }}"
    data-thumb="{{ with $thumbURL }}{{ . }}{{ end }}"
    {{ with $videoTitle }}data-video-title="{{ . }}"{{ end }}>

    {{- /* Thumbnail image (placeholder initially, JS will set correct src) */ -}}
    <img
      class="video-thumbnail"
      src="data:image/svg+xml;charset=utf-8,{{ $blankPlaceholder }}"
      alt="{{ if ne $videoTitle "" }}Thumbnail for video: {{ $videoTitle }}{{ else }}YouTube Thumbnail{{ end }}"
      loading="lazy"
      decoding="async">

    {{- /* Optional privacy notice overlay */ -}}
    {{ if and (eq .Site.Params.show_privacy_notice true) (or .Site.Params.youtube_privacy_notice_text "") }}
      <div class="video-overlay">
        {{ with .Site.Params.youtube_privacy_notice_text }}
          {{ . }}
        {{ else }}
          Click to load video from YouTube. Personal data may be transferred.
        {{ end }}
      </div>
    {{ end }}

    {{- /* Play button icon */ -}}
    <div class="video-play-button"></div>
  </button>

  {{- /* Noscript fallback for users without JavaScript */ -}}
  <noscript>
    <div class="video-noscript">
      {{- if $fallbackThumb -}}
        <img src="{{ $fallbackThumb | safeURL }}"
             alt="{{ if ne $videoTitle "" }}Thumbnail for video: {{ $videoTitle }}{{ else }}YouTube Thumbnail{{ end }}">
      {{- end -}}
      {{- if $videoLink -}}
        <p>
          <a href="{{ $videoLink | safeURL }}" target="_blank" rel="noopener noreferrer">
            {{- if ne $videoTitle "" -}}
              Open video on YouTube: {{ $videoTitle }}
            {{- else -}}
              Open video on YouTube
            {{- end -}}
          </a>
        </p>
      {{- end -}}
    </div>
  </noscript>
{{- end -}}
