{{- $includeAssets := true -}}
{{- with .Page -}}
  {{- if .Scratch.Get "yt-nocookie-assets" -}}
    {{- $includeAssets = false -}}
  {{- else -}}
    {{- .Scratch.Set "yt-nocookie-assets" true -}}
  {{- end -}}
{{- end -}}

{{- if $includeAssets }}
<style>
.video-wrapper {
  position: relative;
  padding-bottom: 56.25%;
  height: 0;
  max-width: 100%;
  overflow: hidden;
  background-color: #000;
  cursor: pointer;
  outline: none;
}

.video-wrapper[data-is-loaded="true"] {
  cursor: auto;
}

.video-wrapper:focus-visible {
  outline: 3px solid #e53935;
  outline-offset: 4px;
}

.video-wrapper.rounded-corners {
  border-radius: 10px;
}

.video-thumbnail {
  position: absolute;
  width: 100%;
  height: 100%;
  object-fit: contain;
  background-color: #000;
  z-index: 1;
}

.video-overlay {
  position: absolute;
  bottom: 0;
  left: 0;
  width: 100%;
  background: rgba(0, 0, 0, 0.85);
  color: white;
  text-align: center;
  font-size: 0.85em;
  padding: 0.5em 1em;
  z-index: 2;
  pointer-events: auto;
}

.video-wrapper.rounded-corners .video-overlay {
  border-radius: 0 0 10px 10px;
}

.video-play-button {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 68px;
  height: 48px;
  background-color: rgba(255, 0, 0, 0.8);
  border-radius: 12px;
  z-index: 3;
  pointer-events: none;
}

.video-play-button::before {
  content: '';
  position: absolute;
  left: 26px;
  top: 14px;
  width: 0;
  height: 0;
  border-left: 18px solid white;
  border-top: 12px solid transparent;
  border-bottom: 12px solid transparent;
}

.video-wrapper iframe {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  border: none;
  z-index: 4;
}
</style>

<script>
(function(){
  function parseId(raw) {
    if (!raw) return { type: 'unknown' };
    raw = raw.trim();
    // Full URL handling
    try {
      if (raw.startsWith('http')) {
        const u = new URL(raw);
        const list = u.searchParams.get('list');
        const v = u.searchParams.get('v');
        if (list) return { type: 'playlist', id: list };
        if (!v && u.hostname.includes('youtu.be')) {
          const pathId = u.pathname.replace(/^\//,'');
          if (/^[a-zA-Z0-9_-]{11}$/.test(pathId)) return { type: 'video', id: pathId };
        }
        if (v && /^[a-zA-Z0-9_-]{11}$/.test(v)) return { type: 'video', id: v };
      }
    } catch(e) { /* ignore */ }

    // Playlist-like IDs
    if (/^(PL|OL|UU|LL|FL)/i.test(raw)) return { type: 'playlist', id: raw };
    // Plain 11-char video ID
    if (/^[a-zA-Z0-9_-]{11}$/.test(raw)) return { type: 'video', id: raw };

    // Fallback: extract list=...
    const m = raw.match(/list=([^&]+)/);
    if (m) return { type: 'playlist', id: m[1] };

    return { type: 'unknown' };
  }

  function enhanceEmbeds() {
    document.querySelectorAll('.video-wrapper').forEach(wrapper => {
      if (wrapper.dataset.listenersAdded === 'true') return;
      wrapper.dataset.listenersAdded = 'true';

      let raw = wrapper.dataset.videoId || '';
      if (raw.length > 2048) { console.warn('video id too long, treating as unknown'); raw=''; }

      const customThumb = wrapper.dataset.thumb || '';
      const safeThumb = /^https?:\/\//i.test(customThumb) ? customThumb : '';
      const providedTitle = wrapper.dataset.videoTitle || '';

      const kind = parseId(raw);
      const overlay = wrapper.querySelector('.video-overlay');
      const thumbnail = wrapper.querySelector('.video-thumbnail');

      // Thumbnails
      if (safeThumb) {
        thumbnail.onerror = null;
        thumbnail.src = safeThumb;
      } else if (kind.type === 'playlist') {
        const svg = `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1280 720'>`+
                    `<rect width='100%' height='100%' fill='#000'/>`+
                    `<rect x='220' y='260' width='840' height='60' fill='#fff'/>`+
                    `<rect x='220' y='340' width='660' height='60' fill='#fff'/>`+
                    `</svg>`;
        thumbnail.src = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg);
      } else if (kind.type === 'video') {
        thumbnail.src = `https://img.youtube.com/vi/${kind.id}/maxresdefault.jpg`;
        thumbnail.onerror = () => { thumbnail.onerror = null; thumbnail.src = `https://img.youtube.com/vi/${kind.id}/0.jpg`; };
      } // unknown keeps the neutral placeholder

      function loadEmbed() {
        if (wrapper.dataset.isLoaded === 'true') return;
        let src = '';
        if (kind.type === 'playlist') {
          src = `https://www.youtube-nocookie.com/embed/videoseries?list=${encodeURIComponent(kind.id)}&autoplay=1&mute=1`;
        } else if (kind.type === 'video') {
          src = `https://www.youtube-nocookie.com/embed/${encodeURIComponent(kind.id)}?autoplay=1&mute=1`;
        } else {
          src = `https://www.youtube-nocookie.com/embed/${encodeURIComponent(raw)}?autoplay=1&mute=1`;
        }
        const iframe = document.createElement('iframe');
        iframe.setAttribute('allowfullscreen','');
        iframe.setAttribute('loading','lazy');
        iframe.setAttribute('title', providedTitle ? `YouTube video player: ${providedTitle}` : 'YouTube video player');
        iframe.src = src;
        // clear and insert
        wrapper.innerHTML = '';
        wrapper.appendChild(iframe);
        wrapper.dataset.isLoaded = 'true';
        wrapper.removeAttribute('role');
        wrapper.removeAttribute('tabindex');
        wrapper.removeAttribute('aria-label');
      }

      // click anywhere inside wrapper
      wrapper.addEventListener('click', loadEmbed);
      if (overlay) overlay.addEventListener('click', loadEmbed);
      if (thumbnail) thumbnail.addEventListener('click', loadEmbed);

      wrapper.addEventListener('keydown', event => {
        if (event.key === 'Enter' || event.key === ' ') {
          event.preventDefault();
          loadEmbed();
        }
      });
    });
  }

  enhanceEmbeds();
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', enhanceEmbeds);
  }
})();
</script>
{{- end }}

{{- $videoTitle := "" -}}
{{- with .Get "title" -}}
  {{- $videoTitle = . -}}
{{- end -}}
{{- if and (eq $videoTitle "") (ge (len .Params) 3) -}}
  {{- $videoTitle = index .Params 2 -}}
{{- end -}}
{{- $ariaLabel := "Play YouTube video" -}}
{{- if ne $videoTitle "" -}}
  {{- $ariaLabel = printf "Play video: %s" $videoTitle -}}
{{- end -}}

<div class="video-wrapper{{ with .Site.Params.youtube_video_class }} {{ . }}{{ end }}{{ if eq .Site.Params.rounded_thumbnails true }} rounded-corners{{ end }}"
  role="button"
  tabindex="0"
  aria-label="{{ $ariaLabel }}"
  data-video-id="{{ .Get 0 }}"
  data-thumb="{{ with .Get 1 }}{{ . }}{{ end }}"
  {{ with $videoTitle }}data-video-title="{{ . }}"{{ end }}>
  <img
    class="video-thumbnail"
    src="data:image/svg+xml;charset=utf-8,{{ printf "%s" (replace (replace (replace (replace "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1280 720'><rect width='100%%' height='100%%' fill='#000'/></svg>" "#" "%23") "<" "%3C") ">" "%3E") "\n" "%0A") }}"
    alt="{{ if ne $videoTitle "" }}Thumbnail for video: {{ $videoTitle }}{{ else }}YouTube Thumbnail{{ end }}">

  {{ if and (eq .Site.Params.show_privacy_notice true) (or .Site.Params.youtube_privacy_notice_text "") }}
    <div class="video-overlay">
      {{ with .Site.Params.youtube_privacy_notice_text }}
        {{ . }}
      {{ else }}
        Click to load video from YouTube. Personal data may be transferred.
      {{ end }}
    </div>
  {{ end }}

  <div class="video-play-button"></div>
</div>
